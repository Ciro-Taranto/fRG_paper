%
% Latex file for Vertex approximation
%
%

%For the parametrization of the vertex, we use bosonic exchange frequencies $\OmPP=\nu_1 + \nu_2$,  
%$\OmPH = \nu_2 - \nu_3$ and $\OmPHC = \nu_3 - \nu_1$.
%If not specify otherwise, we use capital letters for bosonic frequency transfer opposite to fermionic ones.

In order to deal with the frequency and momentum dependence of the vertex, we start by decomposing it as follows:
\begin{align}
\ve^{\Lambda}(k_1,k_2,k_3) = U - \phi^{\Lambda}_{\mathrm{p}}(k_1+k_2;k_1,k_3) + \phi^{\Lambda}_{\mathrm{m}}(k_3-k_1;k_1,k_2)
 + \frac{1}{2}  \phi^{\Lambda}_{\mathrm{m}}(k_2- k_3;k_1,k_2) - \frac{1}{2} \phi^{\Lambda}_{\mathrm{c}}(k_2-k_3;k_1,k_2),
 \label{eq:decomposition}
\end{align}
where we introduced the pairing channel $\phi_{\mathrm{p}}$, the magnetic channel $\phi_{\mathrm{m}}$ and the charge channel $\phi_{\mathrm{c}}$.
Substituting Eq.~(\ref{eq:decomposition}) in Eq.~(\ref{eq:vertflow}) we obtain: 
\begin{eqnarray}
\nonumber
-\dot \phi^{\Lambda}_{\mathrm{p}}(k_1+k_2;k_1,k_3) +\dot \phi^{\Lambda}_{\mathrm{m}}(k_3-k_1;k_1,k_2)
 + \frac{1}{2}  \dot\phi^{\Lambda}_{\mathrm{m}}(k_2- k_3;k_1,k_2) - \frac{1}{2} \dot\phi^{\Lambda}_{\mathrm{c}}(k_2-k_3;k_1,k_2) =\\ \fl{\mathcal{T}}{pp}(k_1,k_2,k_3) +  
  \fl{\mathcal{T}}{ph}(k_1,k_2,k_3) + \fl{\mathcal{T}}{phc}(k_1,k_2,k_3).
\label{eq:decot}
\end{eqnarray} 
\end{widetext}
We associate the momentum transfer argument of $\mathcal{P}^\Lambda$ in Eqns.~(\ref{eq:tpp}-\ref{eq:tphc}) to the momentum transfer argument of the $\phi_{\mathrm{x}}$ on the right hand side of Eq. \ref{eq:decomposition}.
This way, it is easy to attribute $\fl{\mathcal{T}}{pp}$ to the flow equation of the only function in Eq. (\ref{eq:decot}) that depends explicitly on $k_1+k_2$: $-\dot\phi_{\mathrm{p}}^\Lambda=\fl{\mathcal{T}}{pp}$. 
The same is true for the particle hole crossed channel: $\fl{\mathcal{T}}{phc}=\dot\phi_{\mathrm{m}}^\Lambda$.  We associate to the particle-hole diagram the third and fourth term on the left hand side of Eq.~(\ref{eq:decot}): $\fl{\mathcal{T}}{ph}(k_1,k_2,k_3)=\frac{1}{2}  \dot\phi^{\Lambda}_{\mathrm{m}}(k_2- k_3;k_1,k_2) - \frac{1}{2} \dot\phi^{\Lambda}_{\mathrm{c}}(k_2-k_3;k_1,k_2) $.  
%The flow equation of the full vertex is then distributed to the $\phi$-channels. 
%$\phi$ channels are defined by their respictive flow equations:
Hence the flow equations for $\phi$ then read: 
\begin{align}
\dot{\phi}_{\mathrm{p}}^{\Lambda}(Q;k_1,k_3) &= -\mathcal{T}^{\Lambda}_{\mathrm{pp}}(k_1,Q-k_1,k_3) , \\
\nonumber 
\dot{\phi}_{\mathrm{c}}^{\Lambda}(Q;k_1,k_2) &= 
 -2\mathcal{T}^{\Lambda}_{\mathrm{ph}}(k_1,k_2,k_2-Q) +\\
&\phantom{=}
\phantom{2}\mathcal{T}^{\Lambda}_{\mathrm{phc}}(k_1,k_2,Q+k_1) , \\
\dot{\phi}_{\mathrm{m}}^{\Lambda}(Q;k_1,k_2) &= \mathcal{T}^{\Lambda}_{\mathrm{phc}}(k_1,k_2,Q+k_1), 
\end{align}
where $Q=(\Omega,\bs{Q})$ is a frequency and momentum transfer. 
 
%\end{widetext}

Following Refs. \onlinecite{Husemann2009,Husemann2012}, we address first the momentum dependence. To this end, we introduce a decomposition of 
unity by means of a set of orthonormal form factors for the two fermionic momenta $\{f_{l}(\bs{k})\}$ obeying 
the completeness relation\cite{Lichtenstein2017}:
\begin{equation}
 \int_{\bs{k}}  f_{l}(\bs{k}) f_{m}(\bs{k}) = \delta_{l,m}.
\end{equation}
The procedure outlined here is described in detail, e.g., in Ref. \onlinecite{Lichtenstein2017}.

We can then project each channel on a subset of form factors, whose choice is physically motivated\cite{Husemann2009}. 
Let us stress that if one could keep all the  form factors the expansion would be exact.

For the pairing channel we keep only $f_{s}(\bs{k}) = 1$ and $f_d(\bs{k})=\cos{k_x} - \cos{k_y}$:
\begin{align}
\nonumber
  \phi^{\Lambda}_{\mathrm{p}}(Q;k_1,k_3) =&
    \mathcal{S}_{\bs{Q}}^{\Omega;\nu_1,\nu_3} +   \\ 
    & f_d\left(\frac{\bs{Q}}{2}-\bs{k}_1\right) f_d\left(\frac{\bs{Q}}{2}-\bs{k}_3\right) \mathcal{D}_{\bs{Q}}^{\Omega;\nu_1,\nu_3}.
\end{align}
The divergence in the channel $\mathcal{S}$ is associated to the emergence of $s$-wave superconductivity, while $\mathcal{D}$  to $d$-wave superconductivity.\cite{Metzner2012,Platt2013}

For the charge and magnetic channels we restrict ourselves to $f_{s}(\bs{k})=1$ only:
\begin{align}
  \phi^\Lambda_{\mathrm{c}}(Q;k_1,k_2) &= \mathcal{C}_{\bs{Q}}^{\Omega;\nu_1,\nu_2}, \\
  \phi^\Lambda_{\mathrm{m}}(Q;k_1,k_2) &= \mathcal{M}_{\bs{Q}}^{\Omega;\nu_1,\nu_2},
\end{align}
corresponding to instabilities in the charge and magnetic channels, respectively (for notation simplicity we omit 
the $\Lambda$-dependencies of the channel functions $\mathcal{S}$, $\mathcal{D}$, $\mathcal{C}$ and $\mathcal{M}$).

Let us stress that for each channel in Eq.~(\ref{eq:decomposition}) we have defined \textit{its own} frequency notation, consisting of one transfer frequency in the specific channel 
and two remaining independent fermionic frequencies. 
 At finite temperature the frequency transfer is a bosonic Matsubara frequency.
 
 The choice of the mixed notation is the most natural\cite{Wentzell2017} since the transferred momentum and 
frequency play a special role in the diagrammatics.
Indeed, it is the only dependence generated in second order perturbation theory and the main dependence in finite 
order perturbation theory. This notation is also convenient to express the Bethe-Salpeter equations\cite{Rohringer2012}, which are deeply related to parquet-approximations and fRG.

Although one expects a leading dependence in the bosonic frequency, 
in particular in the weak coupling regime, we will see that in some cases the dependence on fermionic frequencies can become strong and not negligible.

In Refs.~\onlinecite{Husemann2009}, with a simplified frequency dependence, the channel functions above are interpreted as bosonic exchange propagators. Such an interpretation is missing with full frequency-dependence.

The flow equations for the channels $\mathcal{S}$,  $\mathcal{D}$, $\mathcal{C}$ and $\mathcal{M}$ can be derived from the projection onto form factors of Eq. (\ref{eq:tpp})-(\ref{eq:tphc}):
\begin{eqnarray}
\dot{\mathcal{S}}_{\bs{Q}}^{\Omega;\nu_1,\nu_3}  &=& - \int _{\bs{k}_1, \bs{k}_3 } \mathcal{T}_{\mathrm{pp}}(k_1,Q-k_1,k_3); \\ 
\dot{\mathcal{D}}_{\bs{Q}}^{\Omega;\nu_1,\nu_3}  &=& -
\int _{\bs{k}_1,\bs{k}_3}  f_d\left( {\frac{\bs{Q}}{2} - \bs{k}_1} \right ) f_d\left ({\frac{\bs{Q}}{2} - \bs{k}_3} \right)  \nonumber \\ 
 &&\mathcal{T}_{\mathrm{pp}}(k_1,Q-k_1,k_3) ; 
\\
\nonumber
\dot{\mathcal{C}}_{\bs{Q}}^{\Omega;\nu_1,\nu_2} &=& 
\int _{\bs{k}_1,\bs{k}_2}   \mathcal{T}_{\mathrm{phc}}(k_1,k_2,Q+k_1)\\ &-&2\mathcal{T}_{\mathrm{ph}}(k_1,k_2,k_2-Q) ; 
\\ 
\dot{\mathcal{M}}_{\bs{Q}}^{\Omega;\nu_1,\nu_2} & =& 
\int _{\bs{k}_1,\bs{k}_2}  \mathcal{T}_{\mathrm{phc}}(k_1,k_2,Q+k_1). 
\end{eqnarray}
The final equations are then obtained by substituting the decomposition (\ref{eq:decomposition}) into the equations above, and using trigonometric equalities.
As an example we report here the equation for the magnetic channel, while the expression for the other channels are reported in the Appendix: 
\begin{equation}
\dot{\mathcal{M}}_\bs{Q}^{\Omega;\nu_1,\nu_2} = \sum_{\nu}{L_\mathrm{m}}^{\Omega; \nu_1,\nu}_{\mathbf{Q}} P_{\bs{Q}}^{\Omega,\nu} {L_\mathrm{m}}^{\Omega; \nu,\nu_2-\Omega}_{\mathbf{Q}}, 
\end{equation} 	   
with: 
\begin{equation}
P_{\bs{Q}}^{\Omega;\omega} = \int_{\bs{p}}  G^\Lambda_{\bs{p},\omega}S^\Lambda_{\bs{Q}+\bs{p},\Omega+\omega} +G^\Lambda_{\bs{Q}+\bs{p},\Omega+\omega}
S^\Lambda_{\bs{p},\omega}, 
\end{equation} 
and: 
\begin{eqnarray} 
\nonumber
{L_\mathrm{m}}^{\Omega;\nu_1,\nu_2}_{\bs{Q}}&=&U+\mathcal{M}_{\bs{Q}}^{\Omega;\nu_1,\nu_2} \\
\nonumber 
&+& \int_{\bs{p}} \Big \{- \mathcal{S}_{\bs{p}}^{\nu_1+\nu_2;\nu_1,\nu_1+\Omega}  
 \\
 \nonumber 
&-\frac{1}{2}& \mathcal{D}_{\bs{p}}^{\nu_1+\nu_2;\nu_1,\nu_1+\Omega}
[\cos(Q_x)+\cos(Q_y)]
 \\ 
&+\frac{1}{2}& \Big[  \mathcal{M}_{\bs{p}}^{\nu_2-\nu_1-\Omega; \nu_1,\nu_2} 
- \mathcal{C}_{\bs{p}}^{\nu_2-\nu_1-\Omega,\nu_1,\nu_2} \Big] 
\Big \} 
\end{eqnarray}	 
Note that after the momentum integrals in $P$ and $L$ are performed, the right hand side can be expressed as a matrix-matrix multiplication in frequency space, where $\Omega$ and $\mathbf{Q}$ appear as parameters.

After this decomposition, the evaluation of the vertex-flow equation, depending on six arguments, is reduced to the flow of the four functions $\mathcal{S}$, $\mathcal{D}$, $\mathcal{C}$, $\mathcal{M}$ 
each of them depending on three frequencies and one momentum only. In order to compute these equations numerically we discretize the momentum 
dependence on patches covering the Brillouin zone and truncate the frequency dependence to some maximal frequency value. More details about this are given in the Appendix. 

Let us stress that, while the form-factor projection procedure is well defined in momentum space, a similar approximation for the frequency, i.e., reducing the vertex frequency dependence to a frequency transfer only\cite{Karrasch2008a,Husemann2012,Taranto2014}, is more problematic.
Indeed this projection in frequency space requires that the two remaining frequencies are chosen arbitrarily. 
This choice affects quantitatively and qualitatively the results, for reasons that are clear looking at the frequency structure of the vertex, discussed below. 

\subsection{Cutoff scheme}
To use the flow equations defined above we need to specify the $\Lambda$-dependence of the non interacting propagator $G_0^\Lambda$, often referred to as \textit{cutoff scheme}, in connection to the scale-separation of the renormalization group. 
We have used two different cutoffs. 

For most our calculations we have used the \textit{interaction cutoff}, introduced in Ref. \onlinecite{Honerkamp2004}: 
 \begin{equation}
 G_0^\Lambda(k) = \Lambda G_0(k)=\frac{\Lambda}{i\nu+\mu-\varepsilon_{\mathbf{k}} } , 
 \end{equation}
  Where the scale-parameter $\Lambda$ flows from $0$ to $1$%, and  
% with $\varepsilon_{\bs{k}} = -2 t [\cos(k_x)+\cos(k_y)] - 4 t' \cos(k_x)\cos(k_y)$
. $\mu$ is the chemical potential needed to fix the occupation at the desired value $n$. Correspondingly the interacting Green's function reads: 
\begin{equation}
G^\Lambda (k) = \frac{\Lambda}{i\nu - \varepsilon_{\bs{k}} +\mu^{\Lambda}-\Lambda\Sigma^\Lambda(k)} 
\end{equation} 
We have introduced a $\Lambda$-dependent chemical potential to maintain the occupation fixed during the flow. The chemical potential becomes a functional of the flowing self-energy, $\mu=\mu[\Sigma^\Lambda]$, whose value is found by solving the equation:  
\begin{equation}
n = n^{\Lambda}(\mu) \equiv \int_k \frac{e^{i\nu 0^{+}}} {i\nu - \varepsilon_{\bs{k}} +\mu^{\Lambda}-\Lambda\Sigma^\Lambda(k)}. 
\end{equation} 
for $\mu$.  

The main advantage of the interaction cutoff is that  the $\Lambda$-dependent action can be interpreted\cite{Honerkamp2004} as the physical action of the system with rescaled interaction $\tilde{U}^\Lambda = \Lambda^2 U$.

Since $T$ acts as an infrared cutoff, for our purposes we do not need to worry about the fact that this cutoff is not scale-selective, and hence does not regularize possible divergences in the bubbles. 
Furthermore it has been shown in Ref.~\onlinecite{Wentzell2016} that, in the context of the single-impurity Anderson model, the vertex-structures do not depend qualitatively on the cutoff-choice, and the specific effect of the interaction-cutoff on the vertex frequency structure has been studied in detail.  

As a benchmark for the robustness of our results on the cutoff-choice, we have used a soft version of the \textit{frequency selective cutoff} defined\cite{Eberlein2014} by:
\begin{equation}
G_0^\Lambda(k) = \frac{1}{i\mathrm{sign}\sqrt{\nu^2+\Lambda^2 }-\mu- \varepsilon_{\bs{k}}},  
\end{equation}  
with $\Lambda_0=\infty$ and $\Lambda_{\mathrm{f}}=0$. Also in this case we have performed our calculations at fixed occupation. 


For both our cutoff choices at the beginning of the flow one has $G_0^{\Lambda_0}=0$, corresponding to a initial conditions for the self-energy and the vertex  defined by, $\Sigma^{\Lambda_0}=0$ and $V^{\Lambda_0 }= U$. 
   
